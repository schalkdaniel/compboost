<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="compboost">
<!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light">
<script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/5/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>Extending compboost with losses • compboost</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Extending compboost with losses">
<meta property="og:description" content="compboost">
<meta property="og:image" content="https://schalkdaniel.github.io/compboost/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/5/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/5/darkly/bootstrap.css" media="(prefers-color-scheme: dark)">
<!-- preferably CSS --><link rel="stylesheet" href="../../preferably.css">
<link id="css-code-light" rel="stylesheet" href="../../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<link id="css-code-dark" rel="stylesheet" href="../../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">compboost</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-2">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-getting-started">Getting Started</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-getting-started">
    <a class="dropdown-item" href="../../articles/getting_started/about_cboosting.html">About Component-Wise Boosting</a>
    <a class="dropdown-item" href="../../articles/getting_started/use_case.html">First Use-Case</a>
    <a class="dropdown-item" href="../../articles/getting_started/early_stopping.html">Early Stopping</a>
    <a class="dropdown-item" href="../../articles/getting_started/robust_regression.html">Quantile Regression</a>
    <a class="dropdown-item" href="../../articles/getting_started/object_references.html">Reference Based Objects of Compboost</a>
    <a class="dropdown-item" href="../../articles/getting_started/visualizations.html">Visualizing Compboost</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-advanced-topics">Advanced Topics</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-advanced-topics">
    <a class="dropdown-item" href="../../articles/advanced/log_performance.html">Logging Performance Measures</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-functionality">Functionality</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-functionality">
    <a class="dropdown-item" href="../../articles/functionality/baselearner.html">Base-Learner</a>
    <a class="dropdown-item" href="../../articles/functionality/loss.html">Loss Functions</a>
    <a class="dropdown-item" href="../../articles/functionality/logger.html">Logger</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/schalkdaniel/compboost">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>

        
        
        
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Extending compboost with losses</h1>
            
      
      
      <div class="d-none name"><code>ext_losses.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="before-starting">Before Starting<a class="anchor" aria-label="anchor" href="#before-starting"></a>
</h2>
<ul>
<li>Read the <a href="https://danielschalk.com/compboost/articles/getting_started/use_case.html" class="external-link">use-case</a>
site to get to know how to define a <code>Compboost</code> object using
the <code>R6</code> interface</li>
</ul>
</div>
<div class="section level2">
<h2 id="what-is-needed">What is Needed<a class="anchor" aria-label="anchor" href="#what-is-needed"></a>
</h2>
<p><code>compboost</code> was designed to provide a component-wise
boosting framework with maximal flexibility. This vignette gives an
overview how to define custom losses in <code>R</code> as well as in
<code>C++</code> without recompiling the whole package. These custom
losses can be used for training the model and/or logging mechanisms.</p>
<p>The loss function for boosting must be differentiable. Hence, we need
to define the loss function and the gradient. Further, boosting is
initialized as loss optimal constant. To capture this, we have to define
the loss optimal constant as function of a response vector. Having these
three components, it is quite easy to define custom losses.</p>
<p>As showcase, we are rebuilding two different loss functions:</p>
<ul>
<li>The quadratic loss as easy example for <code>C++</code>
</li>
<li>The Poisson loss for counting data as more sophisticated loss
example in <code>R</code>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="define-a-new-loss-with-r">Define a New Loss With <code>R</code><a class="anchor" aria-label="anchor" href="#define-a-new-loss-with-r"></a>
</h2>
<p>For this example we are using the <code>VonBort</code> dataset
provided by the package <code>vcd</code>:</p>
<blockquote>
<p><em>“Data from von Bortkiewicz (1898), given by Andrews &amp;
Herzberg (1985), on number of deaths by horse or mule kicks in 14 corps
of the Prussian army.”</em></p>
</blockquote>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">VonBort</span>, package <span class="op">=</span> <span class="st">"vcd"</span><span class="op">)</span></span></code></pre></div>
<p>We like to model the deaths using a Poisson regression in boosting.
That means we have to define a proper loss function, the gradient, and
the constant initialization.</p>
<p>The scheme for the loss, the gradient, and the constant
initialization is to specify a function of the following form:</p>
<ul>
<li>loss: <code>function (truth, response)</code>
</li>
<li>gradient: <code>function (truth, response)</code>
</li>
<li>constant initializer: <code>function (truth)</code>
</li>
</ul>
<div class="section level3">
<h3 id="the-loss-function">The loss function<a class="anchor" aria-label="anchor" href="#the-loss-function"></a>
</h3>
<p><span class="math display">\[L(y,f) = -\log\left( \exp(f)^y
\exp(\exp(f)) \right) - \log(y!)\]</span></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lossPoisson</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">truth</span>, <span class="va">response</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span><span class="op">^</span><span class="va">truth</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="va">truth</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-gradient-of-the-loss-function">The gradient of the loss function<a class="anchor" aria-label="anchor" href="#the-gradient-of-the-loss-function"></a>
</h3>
<p><span class="math display">\[\frac{\partial}{\partial f} L(y,f) =
\exp(f) - y\]</span></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gradPoisson</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">truth</span>, <span class="va">response</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">-</span> <span class="va">truth</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-constant-initialization">The constant initialization<a class="anchor" aria-label="anchor" href="#the-constant-initialization"></a>
</h3>
<p><span class="math display">\[\mathsf{arg min}_{c\in\mathbb{R}}
\sum_{i = 1}^n L\left(y^{(i)}, c\right) = \log(\bar{y})\]</span></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">constInitPoisson</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">truth</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">truth</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-the-loss">Define the loss<a class="anchor" aria-label="anchor" href="#define-the-loss"></a>
</h3>
<p>Finally, having these three components allows to define a
<code>LossCustom</code> object:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define custom loss:</span></span>
<span><span class="va">my_poisson_loss</span> <span class="op">=</span> <span class="va"><a href="../../reference/LossCustom.html">LossCustom</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">lossPoisson</span>, <span class="va">gradPoisson</span>, <span class="va">constInitPoisson</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="train-a-model">Train a model<a class="anchor" aria-label="anchor" href="#train-a-model"></a>
</h3>
<p>This loss object can be used for any task that requires a loss
object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cboost</span> <span class="op">=</span> <span class="va"><a href="../../reference/Compboost.html">Compboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">VonBort</span>, <span class="st">"deaths"</span>, loss <span class="op">=</span> <span class="va">my_poisson_loss</span><span class="op">)</span></span>
<span><span class="va">cboost</span><span class="op">$</span><span class="fu">addBaselearner</span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"spline"</span>, <span class="va">BaselearnerPSpline</span><span class="op">)</span></span>
<span><span class="va">cboost</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fl">100</span>, trace <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="define-a-new-loss-with-c">Define a New Loss With <code>C++</code><a class="anchor" aria-label="anchor" href="#define-a-new-loss-with-c"></a>
</h2>
<p>For this example, to keep it simple, we are using the
<code>iris</code> dataset with <code>Sepal.Length</code> as target. The
aim is to replicate the quadratic loss. This is achieved by exposing
external pointers to <code>R</code> which hold the function definition
and is passed to the constructor of the <code>LossCustomCpp</code>
class.</p>
<p>A general advise is to write a <code>.cpp</code> file that contains
the whole definition. This file needs to be sourced by
<code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html" class="external-link">Rcpp::sourceCpp()</a></code>.</p>
<p>We have to declare the head first to be able to expose functions:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> arma<span class="op">::</span>mat <span class="op">(*</span>lossFunPtr<span class="op">)</span> <span class="op">(</span><span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> true_value<span class="op">,</span> <span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> prediction<span class="op">);</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> arma<span class="op">::</span>mat <span class="op">(*</span>gradFunPtr<span class="op">)</span> <span class="op">(</span><span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> true_value<span class="op">,</span> <span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> prediction<span class="op">);</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">double</span> <span class="op">(*</span>constInitFunPtr<span class="op">)</span> <span class="op">(</span><span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> true_value<span class="op">);</span></span></code></pre></div>
<p>As the type definition already indicates, the <code>C++</code>
functions require the following signature:</p>
<ul>
<li>loss:
<code>arma::mat lossFun (const arma::mat&amp; truth, const arma::mat&amp; response)</code>
</li>
<li>gradient:
<code>arma::mat gradFun (const arma::mat&amp; truth, const arma::mat&amp; response)</code>
</li>
<li>constant initializer:
<code>constInitFun (const arma::mat&amp; true_value)</code>
</li>
</ul>
<div class="section level3">
<h3 id="the-loss-function-1">The loss function<a class="anchor" aria-label="anchor" href="#the-loss-function-1"></a>
</h3>
<p><span class="math display">\[L(y,f) = -0.5 \left(y -
f\right)^2\]</span></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>arma<span class="op">::</span>mat lossFun <span class="op">(</span><span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> true_value<span class="op">,</span> <span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> prediction<span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> arma<span class="op">::</span>pow<span class="op">(</span>true_value <span class="op">-</span> prediction<span class="op">,</span> <span class="dv">2</span><span class="op">)</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-gradient-of-the-loss-function-1">The gradient of the loss function<a class="anchor" aria-label="anchor" href="#the-gradient-of-the-loss-function-1"></a>
</h3>
<p><span class="math display">\[\frac{\partial}{\partial f} L(y,f) = f -
y\]</span></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>arma<span class="op">::</span>mat gradFun <span class="op">(</span><span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> true_value<span class="op">,</span> <span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> prediction<span class="op">)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> prediction <span class="op">-</span> true_value<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-constant-initialization-1">The constant initialization<a class="anchor" aria-label="anchor" href="#the-constant-initialization-1"></a>
</h3>
<p><span class="math display">\[\mathsf{arg min}_{c\in\mathbb{R}}
\sum_{i = 1}^n L\left(y^{(i)}, c\right) = \bar{y}\]</span></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> constInitFun <span class="op">(</span><span class="at">const</span> arma<span class="op">::</span>mat<span class="op">&amp;</span> true_value<span class="op">)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> arma<span class="op">::</span>accu<span class="op">(</span>true_value<span class="op">)</span> <span class="op">/</span> true_value<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exposing-external-pointer">Exposing external pointer<a class="anchor" aria-label="anchor" href="#exposing-external-pointer"></a>
</h3>
<p>These functions are exposed to an XPtr. This stores the pointer to
the function and can be used as parameter for the
<code>LossCustomCpp</code>.</p>
<p>Note that it is not necessary to export the upper functions,
exporting the pointer is the goal.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>lossFunPtr<span class="op">&gt;</span> lossFunSetter <span class="op">()</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>lossFunPtr<span class="op">&gt;</span> <span class="op">(</span><span class="kw">new</span> lossFunPtr <span class="op">(&amp;</span>lossFun<span class="op">));</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>gradFunPtr<span class="op">&gt;</span> gradFunSetter <span class="op">()</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>gradFunPtr<span class="op">&gt;</span> <span class="op">(</span><span class="kw">new</span> gradFunPtr <span class="op">(&amp;</span>gradFun<span class="op">));</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>constInitFunPtr<span class="op">&gt;</span> constInitFunSetter <span class="op">()</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>constInitFunPtr<span class="op">&gt;</span> <span class="op">(</span><span class="kw">new</span> constInitFunPtr <span class="op">(&amp;</span>constInitFun<span class="op">));</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-the-loss-1">Define the loss<a class="anchor" aria-label="anchor" href="#define-the-loss-1"></a>
</h3>
<p>We can get the pointer to the function after exposing them:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">lossFunSetter</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">gradFunSetter</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">constInitFunSetter</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Now, we can pass the pointer to the <code>LossCustomCpp</code>
class:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_cpp_loss</span> <span class="op">=</span> <span class="va"><a href="../../reference/LossCustomCpp.html">LossCustomCpp</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu">lossFunSetter</span><span class="op">(</span><span class="op">)</span>, <span class="fu">gradFunSetter</span><span class="op">(</span><span class="op">)</span>, <span class="fu">constInitFunSetter</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="train-a-model-1">Train a model<a class="anchor" aria-label="anchor" href="#train-a-model-1"></a>
</h3>
<p>Finally, we use the custom loss to train our model:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cboost</span> <span class="op">=</span> <span class="fu"><a href="../../reference/boostSplines.html">boostSplines</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>, target <span class="op">=</span> <span class="st">"Sepal.Length"</span>,</span>
<span>  loss <span class="op">=</span> <span class="va">my_cpp_loss</span>, trace <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="copyright">
  <p></p>
<p>Developed by Daniel Schalk, Janek Thomas, Bernd Bischl.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
  <p class="preferably">Using <a href="https://preferably.amirmasoudabdol.name/?source=footer" class="external-link">preferably</a> template.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
