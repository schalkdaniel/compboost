<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="compboost">
<!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light">
<script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/5/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>Extending compboost with losses • compboost</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Extending compboost with losses">
<meta property="og:description" content="compboost">
<meta property="og:image" content="https://schalkdaniel.github.io/compboost/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/5/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/5/darkly/bootstrap.css" media="(prefers-color-scheme: dark)">
<!-- preferably CSS --><link rel="stylesheet" href="../preferably.css">
<link id="css-code-light" rel="stylesheet" href="../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<link id="css-code-dark" rel="stylesheet" href="../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">compboost</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-2">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-getting-started">Getting Started</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-getting-started">
    <a class="dropdown-item" href="../articles/basic-about-cwb.html">About component-wise boosting</a>
    <a class="dropdown-item" href="../articles/basic-use-case.html">First use-case</a>
    <a class="dropdown-item" href="../articles/basic-early-stopping.html">Early stopping</a>
    <a class="dropdown-item" href="../articles/basic-robust-reg.html">Quantile regression</a>
    <a class="dropdown-item" href="../articles/basic-obj-refs.html">Reference-based objects in compboost</a>
    <a class="dropdown-item" href="../articles/basic-viz.html">Visualizing compboost</a>
    <a class="dropdown-item" href="../articles/basic-mlr-learners.html">mlr3 learners</a>
    <a class="dropdown-item" href="../articles/basic-production-model.html">Production model</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-advanced-topics">Advanced Topics</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-advanced-topics">
    <a class="dropdown-item" href="../articles/adv-extending-losses.html">Extending losses</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-functionality">Functionality</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-functionality">
    <a class="dropdown-item" href="../articles/fct-baselearner.html">Base learner</a>
    <a class="dropdown-item" href="../articles/fct-loss.html">Loss functions</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/schalkdaniel/compboost">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>

        
        
        
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Extending compboost with losses</h1>
            
      
      
      <div class="d-none name"><code>adv-extending-losses.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="before-starting">Before starting<a class="anchor" aria-label="anchor" href="#before-starting"></a>
</h2>
<ul>
<li>Read the <a href="https://danielschalk.com/compboost/articles/getting_started/use_case.html" class="external-link">use-case</a>
site to get to know how to define a <code>Compboost</code> object using
the <code>R6</code> interface.</li>
</ul>
</div>
<div class="section level2">
<h2 id="what-is-needed">What is Needed<a class="anchor" aria-label="anchor" href="#what-is-needed"></a>
</h2>
<p><code>compboost</code> was designed to provide a component-wise
boosting framework with maximal flexibility. This vignette gives an
overview how to define custom losses in <code>R</code> as well as in
<code>C++</code> without recompiling the whole package. These custom
losses can be used for training the model and/or logging mechanisms.</p>
<p>The loss function for training a model with boosting is required to
be differentiable. Hence, we need to define the loss function and the
gradient. Further, boosting is initialized as loss optimal constant. To
capture this, we have to define the loss optimal constant as function of
a response vector. Having these three components, it is quite easy to
define custom losses.</p>
<p>As showcase, we are rebuilding two different loss functions:</p>
<ul>
<li>The quadratic loss as easy example for <code>C++</code>
</li>
<li>The Poisson loss for counting data as more sophisticated loss
example in <code>R</code>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="define-a-new-loss-in-r">Define a new loss in <code>R</code><a class="anchor" aria-label="anchor" href="#define-a-new-loss-in-r"></a>
</h2>
<p>For this example we are using the <code>VonBort</code> dataset
provided by the package <code>vcd</code>:</p>
<blockquote>
<p><em>“Data from von Bortkiewicz (1898), given by Andrews &amp;
Herzberg (1985), on number of deaths by horse or mule kicks in 14 corps
of the Prussian army.”</em></p>
</blockquote>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">VonBort</span>, package <span class="op">=</span> <span class="st">"vcd"</span><span class="op">)</span></span></code></pre></div>
<p>We like to model the deaths using a Poisson regression in boosting.
That means we have to define a proper loss function, the gradient, and
the constant initialization.</p>
<p>The scheme for the loss, the gradient, and the constant
initialization is to specify a function of the following form:</p>
<ul>
<li>loss: <code>function (truth, response)</code>
</li>
<li>gradient: <code>function (truth, response)</code>
</li>
<li>constant initializer: <code>function (truth)</code>
</li>
</ul>
<div class="section level3">
<h3 id="the-loss-function">The loss function<a class="anchor" aria-label="anchor" href="#the-loss-function"></a>
</h3>
<p><span class="math display">\[L(y,f) = -\log\left( \exp(f)^y
\exp(\exp(f)) \right) - \log(y!)\]</span></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lossPoisson</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">truth</span>, <span class="va">response</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span><span class="op">^</span><span class="va">truth</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="va">truth</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-gradient-of-the-loss-function">The gradient of the loss function<a class="anchor" aria-label="anchor" href="#the-gradient-of-the-loss-function"></a>
</h3>
<p><span class="math display">\[\frac{\partial}{\partial f} L(y,f) =
\exp(f) - y\]</span></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gradPoisson</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">truth</span>, <span class="va">response</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">-</span> <span class="va">truth</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-constant-initialization">The constant initialization<a class="anchor" aria-label="anchor" href="#the-constant-initialization"></a>
</h3>
<p><span class="math display">\[\mathsf{arg min}_{c\in\mathbb{R}}
\sum_{i = 1}^n L\left(y^{(i)}, c\right) = \log(\bar{y})\]</span></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">constInitPoisson</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">truth</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">truth</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-the-loss">Define the loss<a class="anchor" aria-label="anchor" href="#define-the-loss"></a>
</h3>
<p>Finally, having these three components allows to define a
<code>LossCustom</code> object:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define custom loss:</span></span>
<span><span class="va">my_poisson_loss</span> <span class="op">=</span> <span class="va"><a href="../reference/LossCustom.html">LossCustom</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">lossPoisson</span>, <span class="va">gradPoisson</span>, <span class="va">constInitPoisson</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="train-a-model">Train a model<a class="anchor" aria-label="anchor" href="#train-a-model"></a>
</h3>
<p>This loss object can be used for any task that requires a loss
object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cboost</span> <span class="op">=</span> <span class="va"><a href="../reference/Compboost.html">Compboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">VonBort</span>, <span class="st">"deaths"</span>, loss <span class="op">=</span> <span class="va">my_poisson_loss</span><span class="op">)</span></span>
<span><span class="va">cboost</span><span class="op">$</span><span class="fu">addBaselearner</span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"spline"</span>, <span class="va">BaselearnerPSpline</span><span class="op">)</span></span>
<span><span class="va">cboost</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fl">500</span>, trace <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<!-- NOT APPLICABLE AS LONG THE CODE IS BUGGY -----------------------------------------------



## Define a New Loss With `C++`

For this example, to keep it simple, we are using the `iris` dataset with `Sepal.Length` as target. The aim is to replicate the quadratic loss. This is achieved by exposing external pointers to `R` which hold the function definition and is passed to the constructor of the `LossCustomCpp` class.

A general advise is to write a `.cpp` file that contains the whole definition. This file needs to be sourced by `Rcpp::sourceCpp()`.

We have to declare the head first to be able to expose functions:

```cpp
// [[Rcpp::depends(RcppArmadillo)]]
#include <RcppArmadillo.h>

typedef arma::mat (*lossFunPtr) (const arma::mat& true_value, const arma::mat& prediction);
typedef arma::mat (*gradFunPtr) (const arma::mat& true_value, const arma::mat& prediction);
typedef double (*constInitFunPtr) (const arma::mat& true_value);
```

As the type definition already indicates, the `C++` functions require the following signature:

- loss: `arma::mat lossFun (const arma::mat& truth, const arma::mat& response)`
- gradient: `arma::mat gradFun (const arma::mat& truth, const arma::mat& response)`
- constant initializer: `constInitFun (const arma::mat& true_value)`

### The loss function

$$L(y,f) = -0.5 \left(y - f\right)^2$$

```cpp
arma::mat lossFun (const arma::mat& true_value, const arma::mat& prediction)
{
  return arma::pow(true_value - prediction, 2) / 2;
}
```

### The gradient of the loss function

$$\frac{\partial}{\partial f} L(y,f) = f - y$$

```cpp
arma::mat gradFun (const arma::mat& true_value, const arma::mat& prediction)
{
  return prediction - true_value;
}
```

### The constant initialization

$$\mathsf{arg min}_{c\in\mathbb{R}} \sum_{i = 1}^n L\left(y^{(i)}, c\right) = \bar{y}$$

```cpp
double constInitFun (const arma::mat& true_value)
{
  return arma::accu(true_value) / true_value.size();
}
```

### Exposing external pointer

These functions are exposed to an XPtr. This stores the pointer to the function and can be used as parameter for the `LossCustomCpp`.

Note that it is not necessary to export the upper functions, exporting the pointer is the goal.

```cpp
// [[Rcpp::export]]
Rcpp::XPtr<lossFunPtr> lossFunSetter ()
{
  return Rcpp::XPtr<lossFunPtr> (new lossFunPtr (&lossFun));
}

// [[Rcpp::export]]
Rcpp::XPtr<gradFunPtr> gradFunSetter ()
{
  return Rcpp::XPtr<gradFunPtr> (new gradFunPtr (&gradFun));
}

// [[Rcpp::export]]
Rcpp::XPtr<constInitFunPtr> constInitFunSetter ()
{
  return Rcpp::XPtr<constInitFunPtr> (new constInitFunPtr (&constInitFun));
}
```

### Define the loss



We can get the pointer to the function after exposing them:

```r
lossFunSetter()
gradFunSetter()
constInitFunSetter()
```

Now, we can pass the pointer to the `LossCustomCpp` class:

```r
my_cpp_loss = LossCustomCpp$new(lossFunSetter(), gradFunSetter(), constInitFunSetter())

src = "
// [[Rcpp::depends(RcppArmadillo)]]
#include <RcppArmadillo.h>

typedef arma::mat (*lossFunPtr) (const arma::mat& true_value, const arma::mat& prediction);
typedef double (*constInitFunPtr) (const arma::mat& true_value);
// [[Rcpp::export]]

arma::mat cpploss (const arma::mat& true_value, const arma::mat& prediction, const SEXP& lossFun)
{
  Rcpp::XPtr<lossFunPtr> myTempLoss (lossFun);
  lossFunPtr lf = *myTempLoss;
  return lf(true_value, prediction);
}

// [[Rcpp::export]]
double cppinit (const arma::mat& true_value, const SEXP& initFun)
{
  Rcpp::XPtr<constInitFunPtr> myConstInit (initFun);
  constInitFunPtr lf = *myConstInit;
  return lf(true_value);
}
"
Rcpp::sourceCpp(code = src)
cpploss(cbind(1:10), cbind(2:11), lossFunSetter())
cppinit(cbind(1:10), constInitFunSetter())
```

### Train a model

Finally, we use the custom loss to train our model:

```r
cboost = boostSplines(data = iris, target = "Sepal.Length",
  loss = my_cpp_loss, trace = 25)
```
------------------------------------------------------------------------------------------->
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="copyright">
  <p></p>
<p>Developed by Daniel Schalk, Janek Thomas, Bernd Bischl.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
  <p class="preferably">Using <a href="https://preferably.amirmasoudabdol.name/?source=footer" class="external-link">preferably</a> template.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
